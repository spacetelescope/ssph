SSPH is a Shiboleth Service Provider Helper.

Shibboleth is hard for a service provider to use directly.  There is a
huge amount of detail, and you can't get it right without a very good
understanding of SAML.  But, whoever set up your IDP can give you
an Apache server that uses Shibboleth to authenticate access to a
directory on that server.

SSPH is a simple CGI program that offers an easy way for non-Apache
web servers (e.g. Tornado) to get Shibboleth authentication through
an Apache server that has SSPH installed.

SSPH is currently scoped to provide user authentication only.  It
is assumed that your application will track authorization and
perform access control.

SSPH does not implement anonymous users, but your application
can by simply not directing the anonymous users through SSPH.

--
Overview:

Your SP offers a LOGIN button that redirects to a specific URL on the
Apache/Shibboleth server.  This URL includes your application's
session cookie.

SSPH is configured to know your SP and insert authentication results
directly into a database table.  

If the user succeeds in authenticating, they will be redirected back
to a pre-configured URL on your application web site.  

You check the table for whether your session cookie is authenticated.
If it is, it will be accompanied by information about the user who was
authenticated.  If it is not, somebody is trying to spoof you.

--

Your client:

choose these for your service:
	name (private between you and SSPH)
	return URL (where users are redirected back to your web app
		after authenticating)
	database type and access credentials (see below for details)

Enter the name and return URL into the table sp_info.

Make your LOGIN button go to
	https://etcbrady.stsci.edu/Shibboleth.sso/Login?
		target=https://etcbrady.stsci.edu/secure/ssph.cgi?
		sp=name,cookie

	name is the name of your application
	cookie is a crypto session cookie

If the user succeeds in logging in, they will come to your application
at
	RETURN_URL?c=cookie

When the user comes back to RETURN_URL:

	"SELECT blob FROM ssph_auths
		WHERE sp = :1 AND cookie = :2"
		( name, cookie )

The blob will be JSON encoding of whatever information Shibboleth provided
in the environment for the authenticated cgi.

Your application MUST CONFIRM that it issued the session cookie.
If your application did not issue the session cookie, then it is
likely a spoof.

This protocol depends on your client choosing cryptographically strong
session cookies.

Later feature:

some way to generate cryptographic session cookies.

